#!/usr/bin/python
#This file was developed and written by Roland A. Pache, Ph.D., Copyright (C) 2012.

#import libraries
import reimport osimport timeimport sysimport functions_lib
#define functionsstart_time=time.time()#for all input structures
structures_indir_contents=os.listdir(KIC_settings.structures_indir)
for item in structures_indir_contents:	if item.endswith('.pdb'):		input_pdb = os.path.join(structures_indir, item)		pdb_prefix = item.split('.pdb')[0].split('_')[0]		pdb_outdir = os.path.join(outdir, pdb_prefix)		#check for existence of corresponding loop file		loop_file = os.path.join(loops_indir, '%s.loop' % pdb_prefix)		if not os.path.isfile(loop_file):			print('ERROR: loop file of %s not found in %s' % (item, loops_indir))			sys.exit()		#create model subdirs for parallel runs on the cluster (to ensure that models from different runs don't overwrite each other)		for i in range(num_models_offset + 1, num_models_offset + num_models_per_PDB + 1):			model_outdir=os.path.join(pdb_outdir, str(i))			if not os.path.isdir(model_outdir):				os.makedirs(model_outdir)		#write grid engine script		qs_script_name=os.path.join(pdb_outdir, 'KIC_scientific_benchmark-%s.qs' % pdb_prefix)		qsub_t_start = num_models_offset + 1		qsub_t_end = num_models_offset + num_models_per_PDB		qs_script_string='''#!/bin/csh#$ -N KIC_scientific_benchmark#$ -o %(pdb_outdir)s#$ -e %(pdb_outdir)s#$ -cwd#$ -q %(cluster_queue)s#$ -r y#$ -l mem_free=%(memory_requirement)s#$ -l arch=%(cluster_architecture)s#$ -l h_rt=%(runtime_limit)s#$ -t %(qsub_t_start)d-%(qsub_t_end)s'echo start_date:datehostnameecho $SGE_TASK_IDecho
cd %(pdb_outdir)s/$SGE_TASK_ID/%(rosetta_executable)s -database %(rosetta_database)s -loops:input_pdb %(input_pdb)s -in:file:fullatom -loops:loop_file %(loop_file)s -loops:remodel perturb_kic -loops:refine refine_kic -in:file:native %(input_pdb)s -out:prefix %(pdb_prefix)s -overwrite -out:path %(pdb_outdir)s/$SGE_TASK_ID/ -ex1 -ex2 -nstruct 1 -out:pdb_gz -loops:max_kic_build_attempts %(max_kic_build_attempts)d %(extra_rosetta_flags)s'''		if run_test_cycles:			qs_script_string += ' -run:test_cycles'		if use_constant_seed:			qs_script_string += ' -constant_seed'
		qs_script_string+='''echoecho moving .e and .o files to task subdir...mv ../*.e$JOB_ID.$SGE_TASK_ID .mv ../*.o$JOB_ID.$SGE_TASK_ID .echoecho $SGE_TASK_IDecho end_date:date'''